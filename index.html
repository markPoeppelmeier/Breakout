<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Breakout (Square Canvas + Random Bricks + Red Fireball)</title>
  <style>
    /* Center everything using flex */
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    h1 {
      margin: 10px 0;
      text-align: center;
    }
    .game-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* Top UI: speed progress bar */
    .top-ui {
      width: 90%;
      max-width: 400px;
      margin: 5px 0;
      display: flex;
      justify-content: center;
    }
    .top-ui progress {
      width: 100%;
      height: 20px;
    }

    /* Square canvas: 600x600 */
    canvas {
      background: #eee;
      border: 1px solid #000;
      display: block;
      margin: 10px 0;
    }

    .powerup-inventory {
      text-align: center;
      margin-bottom: 10px;
    }
    ul {
      list-style-type: none;
      padding: 0;
      margin: 0;
    }
    li {
      margin: 3px 0;
    }

    .bottom-ui {
      font-size: 18px;
      text-align: center;
      margin-bottom: 10px;
    }

    /* Between-level overlay for choosing one of two power-ups */
    #betweenLevelOverlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.6);
      display: none; /* hidden by default */
      justify-content: center;
      align-items: center;
      z-index: 999; /* on top of everything */
    }
    .between-level-content {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    .powerup-choice {
      display: inline-block;
      margin: 10px;
      padding: 10px 15px;
      border: 2px solid #0095DD;
      border-radius: 8px;
      cursor: pointer;
      font-size: 24px;
    }
    .powerup-choice:hover {
      background-color: #f0f0f0;
    }
  </style>
</head>
<body>

  <h1>Breakout (Square Canvas + Random Bricks + Red Fireball)</h1>

  <div class="game-wrapper">
    <!-- Countdown for speed increase -->
    <div class="top-ui">
      <progress id="speedProgress" max="10" value="10"></progress>
    </div>

    <!-- Square 600x600 canvas -->
    <canvas id="myCanvas" width="600" height="600"></canvas>

    <!-- Power-up inventory display -->
    <div class="powerup-inventory">
      <h2>Power-Ups</h2>
      <ul id="powerupList"></ul>
    </div>

    <!-- Bottom UI: Ball power, etc. -->
    <div class="bottom-ui">
      <span id="ballPowerDisplay">Ball Power: 1</span>
    </div>
  </div>

  <!-- Overlay for between-level choices -->
  <div id="betweenLevelOverlay">
    <div class="between-level-content">
      <h2>Choose a Power-Up!</h2>
      <div id="choicesContainer"></div>
    </div>
  </div>

  <script>
    // --------------------------------------------------------------------------------
    // CANVAS & CONTEXT
    // --------------------------------------------------------------------------------
    const canvas = document.getElementById("myCanvas");
    const ctx = canvas.getContext("2d");

    // Overlay / choice UI
    const overlayEl = document.getElementById("betweenLevelOverlay");
    const choicesContainerEl = document.getElementById("choicesContainer");

    // Pausing the game between levels
    let gamePaused = false;

    // --------------------------------------------------------------------------------
    // GAME STATE
    // --------------------------------------------------------------------------------
    let lives = 3;
    let score = 0;
    let currentLevel = 1;
    let ballPower = 1;

    // Paddle
    let paddleWidth = 75;
    const paddleHeight = 10;
    let paddleX = (canvas.width - paddleWidth) / 2;
    let rightPressed = false;
    let leftPressed = false;
    let paddleMoveSpeed = 4;

    // Balls array (we keep them across levels)
    const ballRadius = 8;
    let balls = [];
    const initialBallSpeedX = 1;
    const initialBallSpeedY = -1;

    // Bricks
    let bricks = [];
    let rowCount = 6;   // e.g. 6 rows
    let colCount = 8;   // e.g. 8 columns
    const brickWidth = 60;
    const brickHeight = 20;
    const brickPadding = 2;
    const brickOffsetTop = 40;
    const brickOffsetLeft = 20;
    let totalBricks = 0;
    let destroyedBricks = 0;

    // --------------------------------------------------------------------------------
    // POWER-UPS
    // --------------------------------------------------------------------------------
    let powerupInventory = {
      bigPaddle: 0,
      extraLife: 0,
      multiBall: 0,
      gun: 0,
      ballPower: 0
    };
    // Falling power-ups
    let powerUps = [];
    const powerUpChance = 0.3;

    // Fireball effect
    let fireballActive = false;
    let fireballTimer = 0; // frames (~600 for 10s at 60fps)

    // All power-up types
    const POWERUP_TYPES = ["bigPaddle", "extraLife", "multiBall", "gun", "ballPower", "fireball"];
    const POWERUP_ICONS = {
      bigPaddle: "ðŸ",
      extraLife: "â¤ï¸",
      multiBall: "ðŸ”®",
      gun: "ðŸ”«",
      ballPower: "ðŸ’ª",
      fireball: "ðŸ”¥"
    };
    const POWERUP_NAMES = {
      bigPaddle: "Big Paddle!",
      extraLife: "Extra Life!",
      multiBall: "Multi-Ball!",
      gun: "Gun!",
      ballPower: "Ball Power!",
      fireball: "Fireball!"
    };

    let powerupMessage = "";
    let powerupMessageTimer = 0;

    // --------------------------------------------------------------------------------
    // BULLETS (gun power-up)
    // --------------------------------------------------------------------------------
    let bullets = [];
    const bulletWidth = 2;
    const bulletHeight = 8;
    let bulletSpeed = 4;

    document.addEventListener("mousedown", (e) => {
      if (!gamePaused && e.button === 0 && powerupInventory.gun > 0) {
        fireBullet();
        powerupInventory.gun--;
        updatePowerupUI();
      }
    });
    function fireBullet() {
      bullets.push({
        x: paddleX + paddleWidth / 2 - bulletWidth / 2,
        y: canvas.height - paddleHeight - 5,
        width: bulletWidth,
        height: bulletHeight,
        speed: bulletSpeed,
        active: true
      });
    }

    // --------------------------------------------------------------------------------
    // SPEED-UP COUNTDOWN (10% every 10s)
    // --------------------------------------------------------------------------------
    let countdown = 10;
    const progressEl = document.getElementById("speedProgress");
    let speedMessage = "";
    let speedMessageTimer = 0;

    setInterval(() => {
      if (!gamePaused) {
        countdown--;
        if (countdown < 0) {
          speedUpGame();
          speedMessage = "Game speed increased by 10%!";
          speedMessageTimer = 120;
          countdown = 10;
        }
        updateProgressBar();
      }
    }, 1000);

    function updateProgressBar() {
      progressEl.value = countdown;
    }

    function speedUpGame() {
      // ball speeds
      balls.forEach(ball => {
        ball.dx *= 1.1;
        ball.dy *= 1.1;
      });
      // bullet speeds
      bullets.forEach(b => {
        b.speed *= 1.1;
      });
      bulletSpeed *= 1.1;
      // falling power-ups
      powerUps.forEach(p => {
        p.speed *= 1.1;
      });
      // paddle
      paddleMoveSpeed *= 1.1;
    }

    // --------------------------------------------------------------------------------
    // EVENT LISTENERS: KEYBOARD & MOUSEMOVE
    // --------------------------------------------------------------------------------
    document.addEventListener("keydown", keyDownHandler);
    document.addEventListener("keyup", keyUpHandler);
    document.addEventListener("mousemove", mouseMoveHandler);

    function keyDownHandler(e) {
      if (!gamePaused) {
        if (e.key === "Right" || e.key === "ArrowRight") {
          rightPressed = true;
        } else if (e.key === "Left" || e.key === "ArrowLeft") {
          leftPressed = true;
        }
      }
    }
    function keyUpHandler(e) {
      if (!gamePaused) {
        if (e.key === "Right" || e.key === "ArrowRight") {
          rightPressed = false;
        } else if (e.key === "Left" || e.key === "ArrowLeft") {
          leftPressed = false;
        }
      }
    }
    function mouseMoveHandler(e) {
      if (!gamePaused) {
        let relativeX = e.clientX - canvas.offsetLeft;
        if (relativeX > 0 && relativeX < canvas.width) {
          paddleX = relativeX - paddleWidth / 2;
        }
      }
    }

    // --------------------------------------------------------------------------------
    // INITIAL GAME START
    // --------------------------------------------------------------------------------
    function initGame() {
      lives = 3;
      score = 0;
      currentLevel = 1;
      ballPower = 1;

      paddleWidth = 75;
      paddleX = (canvas.width - paddleWidth) / 2;
      paddleMoveSpeed = 4;
      bulletSpeed = 4;

      // Clear inventory & effects
      for (let key in powerupInventory) {
        powerupInventory[key] = 0;
      }
      fireballActive = false;
      fireballTimer = 0;

      // Start with a single ball
      balls = [];
      balls.push({
        x: canvas.width / 2,
        y: canvas.height - 40,
        dx: initialBallSpeedX,
        dy: initialBallSpeedY,
        radius: ballRadius,
        active: true
      });

      initLevel();
    }

    // Build random bricks for the current level
    function initLevel() {
      bricks = [];
      destroyedBricks = 0;
      totalBricks = 0;

      // We'll randomly decide if each cell has a brick (e.g. 70% chance)
      for (let r = 0; r < rowCount; r++) {
        for (let c = 0; c < colCount; c++) {
          if (Math.random() < 0.7) {
            let bX = brickOffsetLeft + c * (brickWidth + brickPadding);
            let bY = brickOffsetTop + r * (brickHeight + brickPadding);

            bricks.push({
              x: bX,
              y: bY,
              status: 1,
              hitsLeft: currentLevel
            });
            totalBricks++;
          }
        }
      }
    }

    // Called after user chooses a power-up to proceed to next level
    // We do NOT reset balls or speeds; only build new random bricks
    function goToNextLevel() {
      currentLevel++;
      initLevel();
      gamePaused = false;
    }

    // --------------------------------------------------------------------------------
    // BETWEEN-LEVEL CHOICE
    // --------------------------------------------------------------------------------
    function betweenLevels() {
      // Pause the game
      gamePaused = true;
      // Show overlay
      overlayEl.style.display = "flex";
      // Clear old choice buttons
      choicesContainerEl.innerHTML = "";

      // Pick 2 distinct random power-ups
      let available = [...POWERUP_TYPES];
      let choice1 = available.splice(Math.floor(Math.random() * available.length), 1)[0];
      let choice2 = available.splice(Math.floor(Math.random() * available.length), 1)[0];

      [choice1, choice2].forEach(choice => {
        let btn = document.createElement("div");
        btn.className = "powerup-choice";
        btn.textContent = POWERUP_ICONS[choice];
        btn.title = POWERUP_NAMES[choice];
        btn.onclick = () => {
          // Apply the chosen power-up
          applyPowerUpEffect(choice);
          // Hide overlay
          overlayEl.style.display = "none";
          // Go to next level (doesn't reset balls or speed)
          goToNextLevel();
        };
        choicesContainerEl.appendChild(btn);
      });
    }

    // --------------------------------------------------------------------------------
    // POWER-UP LOGIC
    // --------------------------------------------------------------------------------
    function spawnPowerUp(px, py) {
      let type = POWERUP_TYPES[Math.floor(Math.random() * POWERUP_TYPES.length)];
      powerUps.push({
        x: px,
        y: py,
        type: type,
        active: true,
        width: 16,
        height: 16,
        speed: 2
      });
    }

    function updatePowerUps() {
      for (let p of powerUps) {
        if (!p.active) continue;
        if (!gamePaused) {
          p.y += p.speed;
        }

        // Paddle catch
        if (
          p.y + p.height >= canvas.height - paddleHeight - 5 &&
          p.x + p.width >= paddleX &&
          p.x <= paddleX + paddleWidth
        ) {
          applyPowerUpEffect(p.type);
          p.active = false;
        }
        // Off screen
        if (p.y > canvas.height) {
          p.active = false;
        }
      }
      powerUps = powerUps.filter(p => p.active);
    }

    function applyPowerUpEffect(type) {
      powerupMessage = POWERUP_NAMES[type];
      powerupMessageTimer = 120; // ~2s

      switch (type) {
        case "bigPaddle":
          powerupInventory.bigPaddle++;
          paddleWidth += 30;
          if (paddleWidth > 150) paddleWidth = 150;
          break;

        case "extraLife":
          powerupInventory.extraLife++;
          lives++;
          break;

        case "multiBall":
          powerupInventory.multiBall++;
          spawnAdditionalBalls();
          break;

        case "gun":
          powerupInventory.gun++;
          break;

        case "ballPower":
          powerupInventory.ballPower++;
          ballPower++;
          updateBallPowerUI();
          break;

        case "fireball":
          fireballActive = true;
          fireballTimer = 600; // ~10s
          break;

        default:
          break;
      }
      updatePowerupUI();
    }

    function spawnAdditionalBalls() {
      if (balls.length === 0) return;
      let mainBall = balls[0];
      for (let i = 0; i < 2; i++) {
        let newDx = Math.random() < 0.5 ? 1 : -1;
        let newDy = -1;
        balls.push({
          x: mainBall.x,
          y: mainBall.y,
          dx: newDx,
          dy: newDy,
          radius: ballRadius,
          active: true
        });
      }
    }

    // --------------------------------------------------------------------------------
    // BULLETS
    // --------------------------------------------------------------------------------
    function updateBullets() {
      bullets.forEach(bullet => {
        if (!bullet.active) return;
        if (!gamePaused) {
          bullet.y -= bullet.speed;
        }
        // Off screen
        if (bullet.y + bullet.height < 0) {
          bullet.active = false;
          return;
        }
        // Collisions
        collisionDetectionBullet(bullet);
      });
      bullets = bullets.filter(b => b.active);
    }

    function collisionDetectionBullet(bullet) {
      for (let br of bricks) {
        if (br.status === 1) {
          if (
            bullet.x < br.x + brickWidth &&
            bullet.x + bullet.width > br.x &&
            bullet.y < br.y + brickHeight &&
            bullet.y + bullet.height > br.y
          ) {
            br.hitsLeft -= 1;
            bullet.active = false;
            if (br.hitsLeft <= 0) {
              br.status = 0;
              destroyedBricks++;
              score++;
              if (Math.random() < powerUpChance) {
                spawnPowerUp(br.x + brickWidth / 2 - 8, br.y + brickHeight / 2 - 8);
              }
              checkLevelComplete();
            }
            return; // done checking collisions for this bullet
          }
        }
      }
    }

    // --------------------------------------------------------------------------------
    // BALL COLLISIONS
    // --------------------------------------------------------------------------------
    function collisionDetectionBall(ball) {
      for (let br of bricks) {
        if (br.status === 1) {
          if (
            ball.x > br.x &&
            ball.x < br.x + brickWidth &&
            ball.y > br.y &&
            ball.y < br.y + brickHeight
          ) {
            let oldHits = br.hitsLeft;
            br.hitsLeft -= ballPower;

            // Fireball logic: if ballPower >= oldHits => no bounce
            if (!(fireballActive && ballPower >= oldHits)) {
              ball.dy = -ball.dy;
            }

            if (br.hitsLeft <= 0) {
              br.status = 0;
              destroyedBricks++;
              score++;
              if (Math.random() < powerUpChance) {
                spawnPowerUp(br.x + brickWidth / 2 - 8, br.y + brickHeight / 2 - 8);
              }
              checkLevelComplete();
            }
          }
        }
      }

      // Walls
      // Left/right
      if (ball.x + ball.dx < ball.radius || ball.x + ball.dx > canvas.width - ball.radius) {
        ball.dx = -ball.dx;
      }
      // Top
      if (ball.y + ball.dy < ball.radius) {
        ball.dy = -ball.dy;
      }
      // Bottom
      else if (ball.y + ball.dy > canvas.height - ball.radius) {
        // Paddle or lose
        if (ball.x > paddleX && ball.x < paddleX + paddleWidth) {
          bounceBallOffPaddle(ball);
        } else {
          ball.active = false;
        }
      }
    }

    function checkLevelComplete() {
      if (destroyedBricks === totalBricks) {
        setTimeout(() => {
          betweenLevels();  // sets gamePaused=true, shows overlay
        }, 300);
      }
    }

    function bounceBallOffPaddle(ball) {
      let paddleCenter = paddleX + paddleWidth / 2;
      let distFromCenter = ball.x - paddleCenter;
      let ratio = distFromCenter / (paddleWidth / 2);
      let maxBounceAngle = Math.PI / 3;
      let bounceAngle = ratio * maxBounceAngle;

      let speed = Math.sqrt(ball.dx * ball.dx + ball.dy * ball.dy);
      ball.dx = speed * Math.sin(bounceAngle);
      ball.dy = -Math.abs(speed * Math.cos(bounceAngle));
    }

    // --------------------------------------------------------------------------------
    // DRAW FUNCTIONS
    // --------------------------------------------------------------------------------
    function drawBricks() {
      for (let br of bricks) {
        if (br.status === 1) {
          ctx.beginPath();
          ctx.rect(br.x, br.y, brickWidth, brickHeight);
          ctx.fillStyle = "#0095DD";
          ctx.fill();
          ctx.closePath();

          // HP text
          ctx.font = "14px Arial";
          ctx.fillStyle = "#fff";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.fillText(br.hitsLeft, br.x + brickWidth / 2, br.y + brickHeight / 2);
        }
      }
    }

    // **** THIS IS THE MAIN CHANGE: If fireballActive => ball is red
    function drawBalls() {
      balls.forEach(ball => {
        if (!ball.active) return;
        ctx.beginPath();
        ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
        ctx.fillStyle = fireballActive ? "#ff0000" : "#0095DD";
        ctx.fill();
        ctx.closePath();
      });
    }

    function drawBullets() {
      bullets.forEach(bullet => {
        if (!bullet.active) return;
        ctx.beginPath();
        ctx.rect(bullet.x, bullet.y, bullet.width, bullet.height);
        ctx.fillStyle = "black";
        ctx.fill();
        ctx.closePath();
      });
    }

    function drawPaddle() {
      ctx.beginPath();
      ctx.rect(paddleX, canvas.height - paddleHeight - 5, paddleWidth, paddleHeight);
      ctx.fillStyle = "#0095DD";
      ctx.fill();
      ctx.closePath();
    }

    function drawHUD() {
      ctx.font = "16px Arial";
      ctx.fillStyle = "#0095DD";
      ctx.fillText("Score: " + score, 10, 20);
      ctx.fillText("Lives: " + lives, canvas.width - 70, 20);
      ctx.fillText("Level: " + currentLevel, canvas.width / 2 - 30, 20);
    }

    function drawPowerUps() {
      powerUps.forEach(p => {
        if (!p.active) return;
        ctx.font = "16px Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "top";
        ctx.fillText(POWERUP_ICONS[p.type], p.x + p.width / 2, p.y);
      });
    }

    function drawPowerupMessage() {
      if (powerupMessageTimer > 0) {
        ctx.font = "18px Arial";
        ctx.fillStyle = "green";
        ctx.textAlign = "center";
        ctx.fillText(powerupMessage, canvas.width / 2, 50);
        powerupMessageTimer--;
      }
    }

    function drawSpeedMessage() {
      if (speedMessageTimer > 0) {
        ctx.font = "18px Arial";
        ctx.fillStyle = "red";
        ctx.textAlign = "center";
        ctx.fillText(speedMessage, canvas.width / 2, 70);
        speedMessageTimer--;
      }
    }

    // --------------------------------------------------------------------------------
    // MAIN LOOP
    // --------------------------------------------------------------------------------
    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Always draw the current state
      drawBricks();
      drawBalls();
      drawBullets();
      drawPaddle();
      drawHUD();
      drawPowerUps();
      drawPowerupMessage();
      drawSpeedMessage();

      // If paused, skip the updates but keep drawing the final frame
      if (gamePaused) {
        requestAnimationFrame(draw);
        return;
      }

      // Not paused => update bullets, power-ups, balls, etc.
      updateBullets();
      updatePowerUps();

      // Fireball timer
      if (fireballActive) {
        fireballTimer--;
        if (fireballTimer <= 0) {
          fireballActive = false;
        }
      }

      // Move & collide each active ball
      balls.forEach(ball => {
        if (!ball.active) return;
        collisionDetectionBall(ball);
        ball.x += ball.dx;
        ball.y += ball.dy;
      });
      // Remove lost balls
      balls = balls.filter(b => b.active);

      // If no balls left => lose life
      if (balls.length === 0) {
        lives--;
        if (lives > 0) {
          // Add a single new ball, keep speeds
          balls.push({
            x: canvas.width / 2,
            y: canvas.height - 40,
            dx: initialBallSpeedX,
            dy: initialBallSpeedY,
            radius: ballRadius,
            active: true
          });
        } else {
          alert("GAME OVER");
          document.location.reload();
        }
      }

      // Paddle movement
      if (rightPressed && paddleX < canvas.width - paddleWidth) {
        paddleX += paddleMoveSpeed;
      } else if (leftPressed && paddleX > 0) {
        paddleX -= paddleMoveSpeed;
      }

      requestAnimationFrame(draw);
    }

    // --------------------------------------------------------------------------------
    // UI HELPERS
    // --------------------------------------------------------------------------------
    function updatePowerupUI() {
      const listEl = document.getElementById("powerupList");
      listEl.innerHTML = "";
      for (let type in powerupInventory) {
        let count = powerupInventory[type];
        if (count > 0) {
          let li = document.createElement("li");
          li.textContent = `${POWERUP_ICONS[type]} x ${count}`;
          listEl.appendChild(li);
        }
      }
    }
    function updateBallPowerUI() {
      document.getElementById("ballPowerDisplay").textContent = "Ball Power: " + ballPower;
    }

    // --------------------------------------------------------------------------------
    // START
    // --------------------------------------------------------------------------------
    initGame();
    draw();
  </script>
</body>
</html>
